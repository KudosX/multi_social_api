## Social API to Twitter, Facebook, Linkedin, Instagram and Pinterest:
* Login while maintaining single User even if multiple emails associated with different social logins
* Gemset ruby-2.3.0@rails5.0.0.beta3 
* Ruby 2.3.0
* Rails 5.0.0.beta3

### References for this project
* basic app generated by template.rb (github.com/KudosX/template.rb)
* added gems:
```
gem 'therubyracer'
gem 'omniauth-facebook'
gem 'omniauth-twitter'
gem 'omniauth-linkedin'
gem 'omniauth-pinterest'
gem 'omniauth-instagram'
```
#### Followed the two below blog posts to complete project:
* http://blogs.nbostech.com/2015/08/loginregistration-social-signup-using-ruby-on-rails/
* http://blog.nbostech.com/2015/09/managing-multiple-providerssocial-login-with-existing-user-account-in-rails/

#### With the following as references as well:
* http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/
* https://gist.github.com/blairanderson/761ae067876930523482
* http://davidlesches.com/blog/clean-oauth-for-rails-an-object-oriented-approach
* https://github.com/davidlesches/clean-oauth-core/tree/master/app
* https://github.com/intridea/omniauth/wiki/Managing-Multiple-Providers
* http://www.sitepoint.com/rails-authentication-oauth-2-0-omniauth/
* https://github.com/intridea/omniauth/wiki/List-of-Strategies
* https://github.com/mohitjain/social-login-in-rails/tree/master/app
* https://github.com/arsduo/koala
* https://github.com/sferik/twitter
* https://github.com/arunagw/omniauth-twitter
* https://github.com/jot/omniauth-pinterest/
* https://launchschool.com/blog/facebook-graph-api-using-omniauth-facebook-and-koala
* http://snippets.aktagon.com/snippets/512-how-to-post-a-message-to-the-facebook-wall-with-omniauth-devise
* http://revelry.co/a-beginners-guide-to-using-the-facebook-api-in-your-rails-application-part-1/
* https://github.com/skorks/omniauth-linkedin

#### Getting therubyracer gem to work on mac:
```
brew install v8-315
bundle config --local build.libv8 --with-system-v8
bundle config --local build.therubyracer --with-v8-dir=/usr/local/opt/v8-315
bundle 
```

#### Step 1 - setup devise: 
```
rails g devise:install
rails g devise User
rake db:create
rake db:migrate
```
#### Step 2 - add action to not serve up pages until user authenticated:
add `before_action :authenticate_user!` to application_controller just before `end`

#### Step 3: to view routes
`rake routes` existing routes
- localhost:3000/users/sign_in
- localhost:3000/users/sign_up

#### Step 4: copy all devise views into application
`rails g devise:views` creates views/devise

#### Step 5 - update model to support OmniAuth:
- stop server, run `rails g migration AddColumnsToUsers provider uid first_name last_name`
- add `:default => nil` to :first_name and :last_name columns in migration
- then run `rake db:migrate`

#### Step 6 - add fields first_name, last_name to devise views
- add this code to views/devise/registrations/new.html.erb and edit.html.erb
- add just below `<div class="form-inputs">`
```
<div class="field">
  <%= f.label :first_name %><br />
  <%= f.text_field :first_name%>
</div> 
<div class="field">
  <%= f.label :last_name %><br />
  <%= f.text_field :last_name %>
</div>
```
#### Step 7 - tell the devise engine to permit newly created columns
- add logic to controllers/application_controller.rb just after before_action :authenticate_user!
```
before_action :configure_permitted_parameters, if: :devise_controller?
protected 
def configure_permitted_parameters
  devise_parameter_sanitizer.for(:sign_up) << [:first_name, :last_name]
end
```
#### Step 8 - get client ID(KEY) and SECRET from OAuth Service Providers
- https://dev.twitter.com/oauth/overview/application-owner-access-tokens
- https://apps.twitter.com to create your application
- below are the URL callbacks for the providers, can't use localhost but, IP address
- Facebook: http://localhost:3000/users/auth/facebook/callback
- Twitter: http://127.0.0.1:3000/users/auth/twitter/callback
- Linkedin: http://localhost:3000/users/auth/linkedin/callback
- Instagram: http://localhost:3000/users/auth/instagram/callback
- Pinterest: http://localhost:3000/users/auth/pinterest/callback

#### Step 9 - add ENVIRONMENT VARIABLES to .bash_profile on mac 
- for development mode only
```
export TWITTER_KEY="xxxxxkey_from_twitter_apixxxxxx"
export TWITTER_SECRET="xxxxxxsecret_from_twitter_apixxxxxx"
```

#### Step 10 - add ENVIRONMENT VARIABLES to devise.rb, just before end
```
config.omniauth :twitter, ENV["TWITTER_KEY"], ENV["TWITTER_SECRET"],
                 scope: 'public_profile,email', info_fields: 'id,email,name,link'
```

#### Step 11 - specify service provider in user.rb model and create new class
- add logic to models/user.rb, under class User
```
        :rememberable, :trackable, :validatable,
        :omniauthable, :omniauth_providers => [:twitter]
   def self.from_omniauth(auth)
     where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
       user.provider = auth.provider
       user.uid = auth.uid
       user.email = auth.info.email
       user.password = Devise.friendly_token[0,20]
     end
  end
```

#### Step 12 - edit routes.rb to specify name of controller that will handle callbacks
```
Rails.application.routes.draw do
  devise_for :users, :controllers => { :omniauth_callbacks => "callbacks" }
```

#### Step 13 - create new controllers/callbacks_controllers.rb and add this code
- each provider will need it's own method under CallbacksController class
```
class CallbacksController < Devise::OmniauthCallbacksController
  def twitter
    @user = User.from_omniauth(request.env["omniauth.auth"])
    sign_in_and_redirect @user
  end
end
```